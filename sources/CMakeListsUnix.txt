cmake_minimum_required(VERSION 3.10)

project(presien-lic-app)

set(CMAKE_VERBOSE_MAKEFILE ON)

#find_package(PkgConfig)
#pkg_check_modules(CpuInfo REQUIRED IMPORTED_TARGET libcpuinfo)

add_executable(${PROJECT_NAME}
  SampleBase.cpp
  main.cpp
  AppConfig.cpp
  PresienLic.cpp
)

# Additional include directories
target_include_directories(${PROJECT_NAME} PRIVATE ${CMAKE_CURRENT_SOURCE_DIR}/../include/)

if (UNIX AND NOT APPLE)
set(LINUX TRUE)
endif()

if (LINUX OR MINGW)
    if (CMAKE_CXX_COMPILER_VERSION VERSION_GREATER 9.0)
        set(USE_CPP17 TRUE)
    endif()
    target_compile_definitions(${PROJECT_NAME} PRIVATE _GLIBCXX_USE_CXX11_ABI=1)
endif()

if (USE_SHARED_LIBS)
    set(LIBRARY_LINK_TYPE shared)
    if (APPLE)
        set(LIBRARY_EXTENSION "dylib")
    elseif(WIN32)
		set(LIBRARY_EXTENSION "dll")
    elseif(LINUX)
        set(LIBRARY_EXTENSION "so")
    endif()
else()
    set(LIBRARY_LINK_TYPE static)
    set(LIBRARY_EXTENSION "a")
endif()

EXECUTE_PROCESS( COMMAND uname -m COMMAND tr -d '\n' OUTPUT_VARIABLE ARCHITECTURE )
if( (${ARCHITECTURE} STREQUAL "x86_64") OR (${ARCHITECTURE} STREQUAL "aarch64"))
    message( STATUS "Supported Architecture: ${ARCHITECTURE}" )
else()
    message(FATAL_ERROR "Current Architecture not supported Exiting...")
endif()

set(LIBRARY_PATH_RELATIVE "bin/${ARCHITECTURE}/${LIBRARY_LINK_TYPE}/${CMAKE_BUILD_TYPE}")
set(LIBRARY_PATH "${CMAKE_CURRENT_SOURCE_DIR}/../${LIBRARY_PATH_RELATIVE}")

if (LINUX)
set_target_properties(${PROJECT_NAME}
                      PROPERTIES LINK_FLAGS
                      "-L${LIBRARY_PATH} -Wl,--no-as-needed,--enable-new-dtags,-rpath,.,-rpath,$ORIGIN/../lib,-rpath,$ORIGIN/../../../${LIBRARY_PATH_RELATIVE},-rpath,$ORIGIN,-rpath,$ORIGIN/.")
elseif(MSYS OR MINGW)
set_target_properties(${PROJECT_NAME}
                      PROPERTIES LINK_FLAGS
                      "-L${LIBRARY_PATH} -Wl,--subsystem,console,--no-as-needed,-rpath,.,-rpath,$ORIGIN/../lib,-rpath,$ORIGIN/../../../${LIBRARY_PATH_RELATIVE},-rpath,$ORIGIN,-rpath,$ORIGIN/.")
elseif(APPLE)
set_target_properties(${PROJECT_NAME}
                      PROPERTIES LINK_FLAGS
                      "-L${LIBRARY_PATH} -framework SystemConfiguration -framework Security -framework CoreFoundation -Wl,-rpath,.,-rpath,@rpath/.,-rpath,@rpath,-rpath,@rpath/../lib,-rpath,@rpath/../../../${LIBRARY_PATH_RELATIVE}")
endif()

string(TOUPPER ${LIBRARY_LINK_TYPE} LIBRARY_LINK_TYPE)
if(WIN32 AND USE_SHARED_LIBS)
    add_library(LicenseSpringLib MODULE IMPORTED)
else()
    add_library(LicenseSpringLib ${LIBRARY_LINK_TYPE} IMPORTED)
endif()
set_target_properties(LicenseSpringLib
    PROPERTIES IMPORTED_LOCATION
    "${LIBRARY_PATH}/libLicenseSpring.${LIBRARY_EXTENSION}")


set(LS_LINK_LIBS -lpthread)
if(NOT MINGW)
    list(APPEND LS_LINK_LIBS -lcurl -lssl -lcrypto)
else()
    list(APPEND LS_LINK_LIBS -lcurl-4 -lssl-3-x64 -lcrypto-3-x64)
endif()

if (USE_CPP17)
    target_compile_options(${PROJECT_NAME} PRIVATE -fPIC -std=c++17)
	list(APPEND LS_LINK_LIBS -lstdc++fs)
else()
    target_compile_options(${PROJECT_NAME} PRIVATE -fPIC -std=c++14)
endif()

#target_link_libraries(${PROJECT_NAME} PUBLIC PkgConfig::CpuInfo LicenseSpringLib ${LS_LINK_LIBS} )
target_link_libraries(${PROJECT_NAME} PUBLIC LicenseSpringLib ${LS_LINK_LIBS} )


set_target_properties(${PROJECT_NAME} PROPERTIES
    CXX_STANDARD_REQUIRED YES
    CXX_EXTENSIONS NO
)